# We are using Python 3.7 to run the testsuite
language: python
python:
  - "3.7"

# Global variables
env:
  global:
    - TOOLS_DIR=$HOME/build_tools
    - GNAT_BIN_PATH=$TOOLS_DIR/gnat-community-2020-x86_64-linux-bin
    - GNAT_ARM_BIN_PATH=$TOOLS_DIR/gnat-community-2020-arm-elf-bin
    - GNAT_RV32_BIN_PATH=$TOOLS_DIR/gnat-community-2020-riscv32-elf-bin

os:
  - linux

# Cache directory that allows us to not download GNAT GPL every time, speeding
# up the process.
cache:
  directories:
  - $HOME/build_tools

install:
  # Check if the GNAT package is already available in the cache directory. If
  # not, download it.
  - test -f $GNAT_BIN_PATH ||( mkdir -p $TOOLS_DIR &&  wget https://community.download.adacore.com/v1/4d99b7b2f212c8efdab2ba8ede474bb9fa15888d?filename=gnat-2020-20200429-x86_64-linux-bin -O $GNAT_BIN_PATH)
  - test -f $GNAT_ARM_BIN_PATH ||( mkdir -p $TOOLS_DIR &&  wget https://community.download.adacore.com/v1/2b8ddb644a06808e7d2c6b62edf16d31b02f514f?filename=gnat-2020-20200429-arm-elf-linux64-bin -O $GNAT_ARM_BIN_PATH)
  - test -f $GNAT_RV32_BIN_PATH ||( mkdir -p $TOOLS_DIR &&  wget https://community.download.adacore.com/v1/fe26719b2279dee730d3e5a239d95c9fe926c83d?filename=gnat-2020-20200429-riscv32-elf-linux64-bin -O $GNAT_RV32_BIN_PATH)

  - wget https://raw.githubusercontent.com/AdaCore/gnat_community_install_script/master/install_package.sh
  - wget https://raw.githubusercontent.com/AdaCore/gnat_community_install_script/master/install_script.qs

  - test -d $TOOLS_DIR/native/ ||( sh install_package.sh $GNAT_BIN_PATH $TOOLS_DIR/native/)
  - test -d $TOOLS_DIR/arm-elf/ ||( sh install_package.sh $GNAT_ARM_BIN_PATH $TOOLS_DIR/arm-elf/)
  - test -d $TOOLS_DIR/riscv32-elf/ ||( sh install_package.sh $GNAT_RV32_BIN_PATH $TOOLS_DIR/riscv32-elf/)

  # Add GNAT to $PATH
  - export PATH=$PATH:$TOOLS_DIR/native/bin/
  - export PATH=$PATH:$TOOLS_DIR/arm-elf/bin/
  - export PATH=$PATH:$TOOLS_DIR/riscv32-elf/bin/

script:
  # Show GNAT version for the record
  - $TOOLS_DIR/native/bin/gprbuild --version
  - $TOOLS_DIR/arm-elf/bin/gprbuild --version
  - $TOOLS_DIR/riscv32-elf/bin/gprbuild --version

  # Install extra run-times
  - python $PWD/scripts/install_dependencies.py

  # Build all examples
  - python $PWD/scripts/build_all_examples.py

  # Start the testsuite
  - python $PWD/testsuite/run.py
